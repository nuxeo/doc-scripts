#!/bin/bash

# Env vars:
#  SYNC_ONLY to only sync
#  NO_SYNC to not do the sync

REMOTEHOST=doc@styx.nuxeo.com
REMOTEPATH=/opt/doc/api

HERE=$(cd $(dirname $0); pwd -P)
TLDJAR=$HERE/tlddoc-1.3.jar

BRANCH=${1:-5.5}
VERSION=${2:-$BRANCH}
SRC=$HERE/src
[ -d "$SRC" ] || mkdir -p "$SRC"
SCM_REPO=http://hg.nuxeo.org/nuxeo

LOCAL_REPO="$SRC/nuxeo-$VERSION"
LOCAL_DOC="$SRC/nuxeo-$VERSION-javadoc"
LOCAL_TLDDOC="$SRC/nuxeo-$VERSION-tlddoc"


clone() {
    
    if [ ! -d "$LOCAL_REPO" ]; then
        echo "##### Cloning nuxeo: $SCM_REPO into $LOCAL_REPO ..."
        hg clone $SCM_REPO "$LOCAL_REPO" || exit 1
    fi
    (cd "$LOCAL_REPO" && hg up $BRANCH)
    (cd "$LOCAL_REPO" && python clone.py)

}

add_addons_as_nuxeo_module() {

    cp $LOCAL_REPO/pom.xml $LOCAL_REPO/pom.real
    perl -p -i -e "s,</modules>,  <module>addons</module>\n  </modules>," $LOCAL_REPO/pom.xml

}

remove_addons_as_nuxeo_module() {

    mv -f $LOCAL_REPO/pom.real $LOCAL_REPO/pom.xml

}

keep_old_javadoc() {
    # Keep old files if unchanged, to help caches and crawlers
    OLD="$1"
    NEW="$2"
    [ ! -d $OLD ] && return
    diff -q -s -r -I '<!-- Generated by javadoc' "$OLD" "$NEW" | \
      sed -ne 's/^Files \(.*\) and \(.*\) are identical$/\1 \2/p' | \
      xargs -n 2 cp -p
}

swap_doc() {
    DOCDST="$1"
    DOCTMP="$2"
    rm -rf "$DOCDST.old" || true
    mv "$DOCDST" "$DOCDST.old" || true
    mv "$DOCTMP" "$DOCDST"
}

build_javadoc() {
    DOCTMP="$1"/target/site/apidocs
    DOCDST="$2"
    cd "$1"
    mvn -Pjavadoc javadoc:aggregate || return 1
    [ ! -d "$DOCTMP" ] && return
    keep_old_javadoc "$DOCDST" "$DOCTMP"
    swap_doc "$DOCDST" "$DOCTMP"
}

push_doc() {
    [ -z "$1" ] && return
    [ -z "$2" ] && return
    [ -n "$NO_SYNC" ] && return
    echo "##### running rsync in background"
    ssh $REMOTEHOST mkdir -p $REMOTEPATH/$2
    rsync -z -e ssh -r --delete "$1"/* $REMOTEHOST:$REMOTEPATH/$2 &
}

keep_old_doc() {
    # Keep old files if unchanged, to help caches and crawlers
    OLD="$1"
    NEW="$2"
    [ ! -d $OLD ] && return
    diff -q -s -r "$OLD" "$NEW" | \
      sed -ne 's/^Files \(.*\) and \(.*\) are identical$/\1 \2/p' | \
      xargs -n 2 cp -p
}

build_tlddoc() {
    DOCTMP="$1"/target/site/tlddoc
    DOCDST="$2"
    [ ! -e $TLDJAR ] && wget -O$TLDJAR http://maven.nuxeo.org/nexus/service/local/repositories/ibiblio-releases/content/taglibrarydoc/tlddoc/1.3/tlddoc-1.3.jar
    cd "$1"
    find . -name "*.tld" |grep -v target | xargs java -jar $TLDJAR -d $DOCTMP
    # mvn package -Dmaven.test.skip=true net.sourceforge.maven-taglib:maven-taglib-plugin:taglibdoc || return 1
    [ ! -d "$DOCTMP" ] && return
    keep_old_doc "$DOCDST" "$DOCTMP"
    swap_doc "$DOCDST" "$DOCTMP"
}

update() {
    echo "######## nuxeo-$VERSION start generating doc"
    NO_SYNC="y"
    if [ -n "$SYNC_ONLY" ]; then
        push_doc "$LOCAL_DOC" nuxeo/$VERSION/javadoc
        [ -z "$LOCAL_TLDDOC" ] || push_doc "$LOCAL_TLDDOC" nuxeo/$VERSION/tlddoc
    else
        clone
        add_addons_as_nuxeo_module
        build_javadoc "$LOCAL_REPO" "$LOCAL_DOC" && push_doc "$LOCAL_DOC" nuxeo/$VERSION/javadoc
        [ -z "$LOCAL_TLDDOC" ] || \
            (build_tlddoc "$LOCAL_REPO" "$LOCAL_TLDDOC" && \
             push_doc "$LOCAL_TLDDOC" nuxeo/$VERSION/tlddoc)
        remove_addons_as_nuxeo_module
    fi
    echo "######## nuxeo-$VERSION end"
}


update

